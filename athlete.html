<!DOCTYPE html>
<html>
  <head>
      <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
      <script type="text/javascript" src="js/helpers.js"></script>
      <script type="text/javascript" src="js/logic.js"></script>
      <script type="text/javascript" src="js/database.js"></script>
      <script type="text/javascript">
        google.charts.load('current', {'packages':['table', 'scatter']});
        google.charts.setOnLoadCallback(function fillTableAndDrawChart() {

          var athleteName = getURLParams("name");
          var year = getURLParams("year");
          var competition = getURLParams("competition");

          //TODO: athletes page

          if (athleteName == null) {
            window.location.href = "index.html";
            alert("Athlete name is null. Redirecting.");
          }

          document.title = "Upforce :: " + athleteName;
          console.log("Fetching athlete data: " + athleteName);

          getAthleteResults(athleteName, year, competition).send(function handleQueryResponse(response) {

            if (response.isError()) {
              alert('Error in query: ' + response.getMessage() + ' ' + response.getDetailedMessage());
              return;
            }

            var data = response.getDataTable();

            for (var i = 0; i < data.getNumberOfRows(); i++) {
              var competition = data.getValue(i, 1);
              var date = new Date(data.getValue(i, 0));
              data.setValue(i, 1, "<a href=competition.html?competition=" + encodeURIComponent(competition) + "&year=" + date.getFullYear() + ">" + competition  + "</a>");
            }

            var table = new google.visualization.Table(document.getElementById('table_div'));
            var options = {
              width: '50%', //height: '100px',
              alternatingRowStyle: true,
              sortAscending: false,
              sortColumn: 0,
              page: "enable",
              pageSize: 15,
              allowHtml: true
            };

            table.draw(data, options);

            var dataView = new google.visualization.DataView(data);

            dataView.setColumns([
              { sourceColumn: 0, role: 'domain', type: 'date', label: 'Date' },
              { sourceColumn: 1, role: 'annotation', type: 'string', label: 'Competition'},
              { sourceColumn: 4, role: 'data', type: 'number', label: 'Snatch' },
              { sourceColumn: 5, role: 'data', type: 'number', label: 'Clean & Jerk' }
            ]);

            var chart = new google.charts.Scatter(document.getElementById('scatterchart'));
            var options = {
              chart: {
                title: 'Athlete progress',
                subtitle: 'Competition maxes'
              },
              vAxis: { viewWindow: { max: 190, min: 60 } }
            };

            chart.draw(dataView, google.charts.Scatter.convertOptions(options));
          });
        });
      </script>
    <meta charset="utf-8">
    <title>Upforce</title>
  </head>
  <body align="center">
    <div id="table_div"></div>
    <br>
    <div id="scatterchart" style="width: 1000px; height: 400px"></div>
  </body>
</html>
